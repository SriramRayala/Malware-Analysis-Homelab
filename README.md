# Malware-Analysis-Homelab

Introduction
Building the right malware analysis environment is the first step for every malware researcher. When all system configurations and software installations are complete, you’re able to analyze and investigate malware properly. In this post, I wanted to share my own experiences and scripts to help ease the workload of setting up a malware environment to explore malicious software.

In this post, you will learn how to:

download, install and configure a free Windows 10 and a free REMnux Linux virtual machine
set up a virtual private network for communication between virtual machines
build a custom Windows malware environment with SentinelLabs RevCore Tools
learn how to capture network traffic from a Windows 10 virtual machine
Installing Virtual Machines
When running multiple virtual machines, the host operating system will begin slowing down, so it is critical to set each virtual machine’s best requirements to optimize its performance. To set up the virtual machines in this post, I recommend that the Windows 10 virtual machine be set with the minimum requirements of two processor cores with 4GB of RAM and the Linux virtual machine with two processor cores with 2GB of RAM.

Downloading a Free Windows 10 Installation
Microsoft provides a free virtual machine which is intended for testing IE and Edge web browsers. To download the Microsoft virtual machine go to https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/ and download the MSEdge on Windows 10 zip file and select your preferred VM platform, currently I’m using VM Fusion.



Downloading REMnux Linux
The next virtual machine we want to download is REMnux Linux. The REMnux distro is a Linux distribution based on Ubuntu. It has excellent tools for exploring network interactions for behavioral analysis and investigating system-level interactions of malware. To download REMnux go to https://docs.remnux.org/install-distro/get-virtual-appliance and download the Virtual Machine platform of your choice.



Installing and Configuring a Private Isolated Custom Network
Creating an isolated, controlled network environment when analyzing malware is extremely important due to the level of interaction it gives you with malware. VMware Fusion gives you the capabilities to change key networking settings and add a virtual private network configuration to use for analysis between hosts. We will only add two virtual machines to this lab environment, but you can add many virtual machines to this network. The procedures to create this network is as follows:

Select the tab VMware Fusion->Preferences->Network; click the lock icon to make changes
Select the “+” button which creates a vmnet# under the Custom section.
Do not select the “Allow Virtual machines on this network to connect to external networks (using NAT)” option.
Add a Subnet IP: I’ve entered 10.1.2.0
Click Apply


Windows 10 Setup
Once you’ve created a custom network and both virtual machines have been downloaded, begin by unzipping the MSEdge Windows 10. Since I’m using VMware Fusion, I will go through how to import the virtual image; the process for importing the virtual machine with other platforms is similar.

Open up VMware Fusion and follow these steps:

After the zip has been unpacked enter the MSEdge-Win10-VMware folder.
Select in VMware Fusion File->Import MSEdge_Win10_VMware, hit Continue and save the Virtual Machine; it will take a few minutes to import the image.
Click on Customize Settings after the image has been imported.
Click into the Processors & Memory tab and confirm that the settings has two processor cores and the memory is 4096MB.
Before powering on the MSEdge Win10 virtual machine, take a snapshot and name it something like “VM Clean Import”.
When starting the virtual machine, if prompted to upgrade the virtual machine to greater feature compatibility support, choose Upgrade.
The password to the virtual machine is Passw0rd!
Open the command prompt to activate the virtual machine, type slmgr.vbs /ato.
When prompted, install VMware’s “Virtual Tools” and reboot.
Once the virtual machine has rebooted, complete login and immediately take a snapshot. Give it a descriptive name, such as “Activation and VM Tools Install” snapshot.


REMnux Setup
The REMnux virtual machine downloads as an .ova file. I recommend you browse to docs.REMnux.org to confirm the hash of the downloaded OVA file.



If you are using VirtualBox, you can just import REMnux, but if you are using VMware Fusion or VMware Workstation, follow these instructions to import the REMnux:

Select File->Import->Choose File… and select remnux-v7, hit Continue and then Save.
When the import is complete, click on Customize Settings.
Click into the Processors & Memory pane under System Settings and leave the settings with two processor cores; reduce the memory from 4096MB to 2048MB.
For the REMnux network configuration, the setup is slightly different. We want to add an additional network adapter.Note: There are multiple reasons why I configure this virtual machine this way. If I need to update or download other software having the network adapter configured saves me time; the second is if I want to allow malware callouts.Once the import is complete and you’re in the “Settings” menu, select Network Adapter. The next step is to click Add Device… and select Network Adapter and Add…. Make sure the Share with my Mac radio button is set. Return to the main “Settings” panel and select Network Adapter 2. Click the vmnet2 radio button, then choose Show All to go back to Settings.
When starting the REMnux virtual machine, if prompted to upgrade the virtual machine to greater feature compatibility support, choose Upgrade.
Once REMnux boots, the credentials are: Username: remnux Password: malware.
I always change the password on my virtual machines:
$passwd
UNIX password: malware
Enter new UNIX password: (your choice)
The next step is to configure the network settings. If you type ifconfig -a you should see two network adapters:
Select NAT for the first network adapter. The virtual machine will get an address on that network from the VMware virtual DHCP server. You can ping google to see if you have connectivity or open the Firefox browser and connect to any website to confirm that you have internet access. If you do not, then type this command in terminal: $ sudo dhclient -r This should allow you to fetch an IP.
For the second adapter, ens37, type in this command:$ sudo ifconfig ens37 10.1.2.1 netmask 255.255.255.0
Hit the “Snapshot” button and name it something like “Clean Snapshot”.
Update and upgrade REMnux:$ sudo apt-get update; sudo apt-get upgrade
